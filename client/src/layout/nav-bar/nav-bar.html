<div class="navbar fixed top-0 z-30 bg-linear-to-r from-primary to-black text-white shadow-md px-4">
  <!-- ================= LEFT ================= -->
  <div class="navbar-start">
    <!-- Mobile Menu -->
    <div class="dropdown">
      <div tabindex="0" role="button" class="btn btn-ghost btn-circle lg:hidden text-white">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-8 w-8"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2.5"
            d="M4 6h16M4 12h16M4 18h16"
          />
        </svg>
      </div>

      <!-- MOBILE DROPDOWN -->
      <ul
        tabindex="0"
        class="menu menu-sm dropdown-content mt-2 z-1 p-3 shadow-xl bg-base-100 text-base-content rounded-2xl w-64"
      >
        <!-- MAIN -->
        <li>
          <a
            routerLink="/"
            class="hover:bg-primary hover:text-white rounded-xl transition-all duration-200"
          >
            Home
          </a>
        </li>

        @if (accountService.currentUser(); as user) {
          <li>
            <a
              routerLink="/members"
              class="hover:bg-primary hover:text-white rounded-xl transition-all duration-200"
            >
              Matches
            </a>
          </li>
          @if (accountService.isNormalUser()) {
            <li>
              <a
                routerLink="/messages"
                class="hover:bg-primary hover:text-white rounded-xl transition-all duration-200"
              >
                Messages
              </a>
            </li>
          }

          <li *appHasRole="['Admin', 'Moderator']">
            <a
              routerLink="/admin"
              class="hover:bg-primary hover:text-white rounded-xl transition-all duration-200"
            >
              Admin
            </a>
          </li>

          <li>
            <a
              routerLink="/lists"
              class="hover:bg-primary hover:text-white rounded-xl transition-all duration-200"
            >
              Lists
            </a>
          </li>

          <!-- ACCOUNT SECTION -->
          <li class="menu-title mt-4 text-primary text-xs uppercase tracking-wider">
            <span>Account</span>
          </li>
          @if (accountService.isNormalUser()) {
            <!-- ðŸ”” Notification Bell -->
            <div class="dropdown dropdown-end">
              <div tabindex="0" role="button" class="relative btn btn-ghost btn-circle">
                <i class="pi pi-bell text-xl text-white"></i>

                @if (notificationService.count() > 0) {
                  <span
                    class="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full min-w-[18px] h-[18px] px-1 flex items-center justify-center font-semibold"
                  >
                    {{ notificationService.count() }}
                  </span>
                }
              </div>

              <!-- DROPDOWN CONTENT -->
              <div
                tabindex="0"
                class="dropdown-content mt-3 z-50 w-72 bg-base-100 text-base-content rounded-2xl shadow-xl p-0 overflow-hidden"
              >
                <!-- HEADER -->
                <div class="flex justify-between items-center px-4 py-3 border-b bg-base-200/40">
                  <div>
                    <h3 class="font-semibold text-sm">Notifications</h3>
                    <p class="text-xs opacity-60">
                      {{ notificationService.count() }} unread messages
                    </p>
                  </div>

                  @if (notificationService.count() > 0) {
                    <button
                      class="text-xs text-primary hover:underline"
                      (click)="notificationService.clear()"
                    >
                      Clear All
                    </button>
                  }
                </div>

                <!-- LIST -->
                <div class="max-h-50 overflow-y-auto">
                  @if (notificationService.count() === 0) {
                    <div class="p-8 text-center text-sm opacity-60">ðŸ”” You're all caught up!</div>
                  }

                  @for (notification of notificationService.notifications(); track $index) {
                    <a
                      [routerLink]="['/members', notification.senderId, 'messages']"
                      class="group flex gap-3 px-4 py-3 hover:bg-base-200/60 transition border-b last:border-none"
                      (click)="notificationService.markAsRead(notification.id)"
                    >
                      <!-- Avatar -->
                      <div class="relative">
                        <img
                          [src]="notification.senderImageUrl || 'default_user.jpg'"
                          class="w-9 h-9 rounded-full object-cover"
                        />

                        <!-- Unread Dot -->
                        <span
                          class="absolute bottom-0 right-0 w-3 h-3 bg-primary rounded-full border-2 border-base-100"
                        ></span>
                      </div>

                      <!-- Text -->
                      <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                          <p class="font-semibold truncate">
                            {{ notification.senderDisplayName }}
                          </p>
                          <span class="text-xs opacity-50">New</span>
                        </div>

                        <p class="text-sm opacity-70 truncate mt-1">
                          {{ notification.content }}
                        </p>
                      </div>
                    </a>
                  }
                </div>
              </div>
            </div>
            <li>
              <a
                routerLink="/members/{{ user.id }}"
                class="flex items-center gap-2 hover:bg-primary hover:text-white rounded-xl transition-all duration-200"
              >
                <i class="pi pi-user"></i>
                My Profile
              </a>
            </li>
          }
          <li>
            <a
              (click)="logout()"
              class="flex items-center gap-2 hover:bg-error hover:text-white rounded-xl transition-all duration-200"
            >
              <i class="pi pi-sign-out"></i>
              Logout
            </a>
          </li>
        } @else {
          <!-- LOGIN SECTION -->
          <li class="menu-title mt-4 text-primary text-xs uppercase tracking-wider">
            <span>Login</span>
          </li>

          <li>
            <form class="flex flex-col gap-2 p-2" (ngSubmit)="onLogin()" #mobileLoginForm="ngForm">
              <input
                type="email"
                class="input input-bordered input-sm"
                [(ngModel)]="credentials.email"
                name="email"
                placeholder="Email"
              />

              <input
                type="password"
                class="input input-bordered input-sm"
                [(ngModel)]="credentials.password"
                name="password"
                placeholder="Password"
              />

              <button type="submit" class="btn btn-primary btn-sm w-full rounded-xl">
              @if(loading()){
            <span class="mr-2 loading loading-spinner"></span> 
          }
                Login
              </button>
            </form>
          </li>
        }

        <!-- SYSTEM -->
        <li class="menu-title mt-4 text-primary text-xs uppercase tracking-wider">
          <span>System</span>
        </li>

        <li>
          <a
            routerLink="/errors"
            class="hover:bg-primary hover:text-white rounded-xl transition-all duration-200"
          >
            Errors
          </a>
        </li>
      </ul>
    </div>

    <!-- Logo -->
    <a routerLink="/" class="btn btn-ghost text-xl font-bold text-white">
      <i class="pi pi-users mr-2"></i>
      Dating App
    </a>
  </div>

  <!-- ================= CENTER (Desktop Menu) ================= -->
  <div class="navbar-center hidden lg:flex">
    <ul class="menu menu-horizontal px-1">
      <li>
        <a
          routerLink="/"
          routerLinkActive="font-bold"
          [routerLinkActiveOptions]="{ exact: true }"
          class="text-white"
        >
          Home
        </a>
      </li>

      @if (accountService.currentUser()) {
        <li>
          <a routerLink="/members" routerLinkActive="font-bold" class="text-white">
            @if (accountService.isNormalUser()) {
              <span> Matches</span>
            } @else {
              <span>Members</span>
            }
          </a>
        </li>
        @if (accountService.isNormalUser()) {
          <li>
            <a routerLink="/messages" routerLinkActive="font-bold" class="text-white"> Messages </a>
          </li>
        }
        <li *appHasRole="['Admin', 'Moderator']">
          <a routerLink="/admin" routerLinkActive="font-bold" class="text-white"> Admin </a>
        </li>
        @if (accountService.isNormalUser()) {
          <li>
            <a routerLink="/lists" routerLinkActive="font-bold" class="text-white"> Lists </a>
          </li>
        }
      }

      <li>
        <a routerLink="/errors" routerLinkActive="font-bold" class="text-white"> Errors </a>
      </li>
    </ul>
  </div>

  <!-- ================= RIGHT (Desktop Only Auth Section) ================= -->
  <div class="navbar-end gap-3 hidden lg:flex">
    <!-- Theme Dropdown -->
    <div class="dropdown dropdown-end">
      <div tabindex="0" role="button" class="btn btn-ghost text-white">
        {{ selectedTheme() }}
      </div>
      <ul
        tabindex="0"
        class="dropdown-content menu bg-base-100 text-base-content rounded-box z-1 w-52 p-2 shadow"
      >
        @for (theme of themes; track $index) {
          <li (click)="handleSelectedTheme(theme)">
            <a>{{ theme }}</a>
          </li>
        }
      </ul>
    </div>

    @if (accountService.currentUser(); as user) {
      <!-- ðŸ”” Notification Bell -->
      <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="relative btn btn-ghost btn-circle">
          <i class="pi pi-bell text-xl text-white"></i>

          @if (notificationService.count() > 0) {
            <span
              class="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full min-w-[18px] h-[18px] px-1 flex items-center justify-center font-semibold"
            >
              {{ notificationService.count() }}
            </span>
          }
        </div>

        <!-- DROPDOWN CONTENT -->
        <div
          tabindex="0"
          class="dropdown-content mt-4 z-50 w-80 bg-base-100 text-base-content rounded-3xl shadow-2xl p-0 overflow-hidden"
        >
          <!-- HEADER -->
          <div class="flex justify-between items-center px-5 py-4 border-b bg-base-200/40">
            <div>
              <h3 class="font-semibold text-lg">Notifications</h3>
              <p class="text-xs opacity-60">{{ notificationService.count() }} unread messages</p>
            </div>

            @if (notificationService.count() > 0) {
              <button
                class="text-sm text-primary hover:underline"
                (click)="notificationService.clear()"
              >
                Clear All
              </button>
            }
          </div>

          <!-- LIST -->
          <div class="max-h-50 overflow-y-auto">
            @if (notificationService.count() === 0) {
              <div class="p-8 text-center text-sm opacity-60">ðŸ”” You're all caught up!</div>
            }

            @for (notification of notificationService.notifications(); track $index) {
              <a
                [routerLink]="['/members', notification.senderId, 'messages']"
                class="group flex gap-4 px-5 py-3 hover:bg-base-200/60 transition duration-200 border-b last:border-none"
                (click)="notificationService.markAsRead(notification.id)"
              >
                <!-- Avatar -->
                <div class="relative">
                  <img
                    [src]="notification.senderImageUrl || 'default_user.jpg'"
                    class="w-12 h-12 rounded-full object-cover"
                  />

                  <!-- Unread Dot -->
                  <span
                    class="absolute bottom-0 right-0 w-3 h-3 bg-primary rounded-full border-2 border-base-100"
                  ></span>
                </div>

                <!-- Text -->
                <div class="flex-1 min-w-0">
                  <div class="flex justify-between items-center">
                    <p class="font-semibold truncate">
                      {{ notification.senderDisplayName }}
                    </p>
                  </div>

                  <p class="text-sm opacity-70 truncate mt-1">
                    {{ notification.content }}
                  </p>
                </div>
                <div class="text-sm">
                  {{ notification.messageSent | timeAgo }}
                </div>
              </a>
            }
          </div>
        </div>
      </div>
      <!-- Desktop User Dropdown -->
      <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-ghost flex items-center gap-2 text-white">
          <img [src]="user.imageUrl || 'default_user.jpg'" class="w-8 h-8 rounded-full" />

          <span>{{ user.displayName }}</span>
        </div>

        <ul (click)="handleSelectUserItem()"
          tabindex="0"
          class="dropdown-content menu bg-base-100 text-base-content rounded-box z-1 w-52 p-2 shadow"
        >
          @if (accountService.isNormalUser()) {
            <li>
              <a routerLink="/members/{{ user.id }}">
                <i class="pi pi-user mr-2"></i> My Profile
              </a>
            </li>
          }
          <li>
            <a (click)="logout()"> <i class="pi pi-logout mr-2"></i> Logout </a>
          </li>
        </ul>
      </div>
    } @else {
      <!-- Desktop Login -->
      <form class="flex items-center gap-2" (ngSubmit)="onLogin()" #loginForm="ngForm">
        <input
          type="email"
          class="input input-sm bg-white text-black"
          [(ngModel)]="credentials.email"
          name="email"
          placeholder="Email"
        />

        <input
          type="password"
          class="input input-sm bg-white text-black"
          [(ngModel)]="credentials.password"
          name="password"
          placeholder="Password"
        />

        <button type="submit" class="btn btn-sm btn-primary">
          @if(loading()){
            <span class="mr-2 loading loading-spinner"></span> 
          }
          Login
        </button>
      </form>
    }
  </div>
</div>
